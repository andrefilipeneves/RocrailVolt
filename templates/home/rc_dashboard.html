{% extends "layouts/base.html" %}
{% block title %}RC Car{% endblock title %}

{% block content %}

<div class="row g-3">

  <div class="col-12 col-xl-8">
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <h2 class="h5 mb-0">RC Car + YOLO</h2>
          <small class="text-muted">Stream vídeo + comandos</small>
        </div>
      </div>
      <div class="card-body text-center">
        <!-- Usa o MESMO endpoint que funciona no ROI/LayoutMap -->
<img src="{{ url_for('home_blueprint.yolo_stream') }}"
     alt="YOLO Stream"
     class="img-fluid border rounded" />

      </div>
    </div>

    <div class="card border-0 shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Controlo Manual</h2>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="autopilotToggle" onchange="toggleAutopilot(this)">
          <label class="form-check-label" for="autopilotToggle">Autopilot</label>
        </div>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Direção (steering)</label>
          <input type="range" min="-1" max="1" step="0.1" value="0" class="form-range" id="steeringSlider">
        </div>
        <div class="mb-3">
          <label class="form-label">Aceleração (throttle)</label>
          <input type="range" min="-1" max="1" step="0.1" value="0" class="form-range" id="throttleSlider">
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-primary" onclick="sendManualCommand()">Enviar comando</button>
          <button class="btn btn-sm btn-danger" onclick="emergencyStop()">STOP!</button>
        </div>
        <small class="text-muted d-block mt-2">
          Em modo Autopilot os comandos manuais são ignorados.
        </small>
      </div>
    </div>
  </div>

  <div class="col-12 col-xl-4">
    <div class="card border-0 shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Estado do RC Car</h2>
        <button class="btn btn-sm btn-outline-secondary" onclick="refreshStatus()">Refresh</button>
      </div>
      <div class="card-body">
        <pre id="rcStatus" class="small bg-dark text-light rounded p-2" style="max-height:250px; overflow-y:auto;"></pre>
      </div>
    </div>
  </div>

</div>

<script>
async function refreshStatus() {
  const res = await fetch("{{ url_for('home_blueprint.api_rc_status') }}");
  const data = await res.json();
  document.getElementById("rcStatus").textContent = JSON.stringify(data, null, 2);
  document.getElementById("autopilotToggle").checked = data.autopilot === true;
}

async function sendManualCommand() {
  const s = parseFloat(document.getElementById("steeringSlider").value);
  const t = parseFloat(document.getElementById("throttleSlider").value);
  await fetch("{{ url_for('home_blueprint.api_rc_manual') }}", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ steering: s, throttle: t })
  });
  refreshStatus();
}

async function toggleAutopilot(el) {
  const enabled = el.checked;
  await fetch("{{ url_for('home_blueprint.api_rc_autopilot') }}", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ enabled: enabled })
  });
  refreshStatus();
}

async function emergencyStop() {
  await fetch("{{ url_for('home_blueprint.api_rc_emergency_stop') }}", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: "{}"
  });
  refreshStatus();
}

window.addEventListener("load", refreshStatus);
</script>

{% endblock content %}
